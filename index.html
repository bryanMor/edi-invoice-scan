<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapEDI Pro - v2.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .scroll-hide::-webkit-scrollbar { display: none; }
        .settings-panel { transition: transform 0.3s ease-in-out; }
        
        /* Optimized for exactly 4 thumbnails across */
        .photo-container { position: relative; flex: 0 0 85px; }
        .photo-bubble { 
            width: 85px; 
            height: 125px; 
            object-fit: cover; 
            border-radius: 10px; 
            border: 2px solid #e2e8f0; 
            background: white; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .del-btn { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: #ef4444; 
            color: white; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            font-weight: bold;
            border: 2px solid white; 
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans overflow-x-hidden">

    <div id="settingsOverlay" class="fixed inset-y-0 right-0 w-80 bg-white shadow-2xl z-50 transform translate-x-full settings-panel border-l border-slate-200">
        <div class="p-6">
            <h2 class="text-xl font-black mb-8">Settings</h2>
            <div class="space-y-6">
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full bg-slate-100 rounded-xl p-3 text-sm border focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <button onclick="UI.saveSettings()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg">Save Changes</button>
            </div>
        </div>
    </div>

    <main class="max-w-4xl mx-auto p-4 pb-20">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-black text-indigo-600 italic leading-none">SnapEDI</h1>
                <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mt-1">B-Record Engine v2.4</p>
            </div>
            <button onclick="UI.toggleSettings()" class="p-4 bg-white shadow-sm border rounded-2xl">‚öôÔ∏è</button>
        </div>

        <div class="mb-6">
            <div id="queueHeader" class="hidden flex justify-between items-center mb-3 px-1">
                <span class="text-[10px] font-black uppercase text-slate-400 tracking-tighter">Pages Ready for Batch</span>
                <button onclick="UI.clearQueue()" class="text-[10px] font-black uppercase text-red-500 bg-red-50 px-3 py-1 rounded-full">Clear All</button>
            </div>
            <div id="photoQueue" class="flex gap-4 overflow-x-auto py-2 scroll-hide min-h-[140px]"></div>
        </div>

        <div class="flex gap-3 mb-8">
            <button onclick="document.getElementById('fileInput').click()" class="flex-[2] bg-white border-2 border-indigo-600 text-indigo-600 py-4 rounded-[2rem] font-black uppercase text-xs">Add Page</button>
            <button id="processBtn" onclick="processBatch()" class="flex-[3] hidden bg-indigo-600 text-white py-4 rounded-[2rem] font-black uppercase text-xs shadow-xl">Process Batch</button>
            <input type="file" id="fileInput" class="hidden" multiple onchange="addToQueue(this)">
        </div>

        <div id="summaryCard" class="hidden bg-slate-900 text-white p-8 rounded-[2.5rem] shadow-2xl mb-4">
            <p class="text-slate-400 text-[10px] font-black uppercase mb-1">Grand Total (Net Paid)</p>
            <h2 id="grandTotal" class="text-4xl font-black text-emerald-400 font-mono">$0.00</h2>
        </div>

        <div id="actionButtons" class="hidden grid grid-cols-2 gap-3 mb-8">
            <button onclick="downloadEDI()" class="bg-indigo-600 text-white py-4 rounded-[2rem] font-black text-xs uppercase shadow-lg">Save EDI</button>
            <button onclick="processBatch()" class="bg-white border border-slate-200 py-4 rounded-[2rem] font-black text-xs uppercase">Rescan</button>
        </div>

        <div id="loader" class="hidden flex flex-col items-center py-10 text-center">
            <div class="w-10 h-10 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
            <p class="font-black text-indigo-600 uppercase text-[9px] tracking-widest">Calculating Net Costs...</p>
        </div>

        <div class="mt-8 pt-8 border-t">
            <h3 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest px-1">History (2 Weeks)</h3>
            <div id="historyList" class="space-y-3"></div>
        </div>
    </main>

    <script>
        let fileQueue = [];
        let history = JSON.parse(localStorage.getItem('snap_history') || '[]');

        const Engine = {
            vendorName: "VENDOR",
            invoiceDate: "FEB-01-26",
            items: [],
            margin: 1.35,

            getFileName: function() {
                const words = this.vendorName.toUpperCase().split(' ').filter(w => w.length > 1).slice(0, 2).join('');
                const shortName = words.substring(0, 14);
                return `${shortName}_${this.invoiceDate}.txt`;
            },

            generateEDILine: function(item) {
                const onlyNums = (val) => String(val || "0").replace(/\D/g, "");
                const toCents = (val) => Math.round((Number(val) || 0) * 100).toString().replace(/\D/g, "");

                let upc = onlyNums(item.upc).padStart(11, '0').slice(-11);
                let sku = onlyNums(item.sku).padStart(6, '0').slice(-6);
                let qty = onlyNums(item.qty_ordered).padStart(4, '0').slice(-4);
                let units = onlyNums(item.units_case || 1).padStart(6, '0').slice(-6);
                let cost = toCents(item.net_case_price).padStart(5, '0').slice(-5);
                
                const srpVal = Number(item.suggested_retail) || 0;
                const retailCalc = srpVal > 0 ? srpVal : ((Number(item.net_case_price) || 0) / (Number(item.units_case) || 1)) * this.margin;
                let retail = toCents(retailCalc).padStart(5, '0').slice(-5);

                const desc = String(item.description || "ITEM").toUpperCase().substring(0, 26).padEnd(26, ' ');
                return `B${upc}${desc}${sku}${cost}CS${units}+${qty}${retail}001`;
            }
        };

        const UI = {
            toggleSettings: () => document.getElementById('settingsOverlay').classList.toggle('translate-x-full'),
            saveSettings: () => { localStorage.setItem('snap_edi_key', document.getElementById('apiKeyInput').value); UI.toggleSettings(); },
            clearQueue: () => { fileQueue = []; UI.renderQueue(); },
            removePhoto: (index) => { fileQueue.splice(index, 1); UI.renderQueue(); },

            renderQueue: () => {
                const q = document.getElementById('photoQueue');
                const head = document.getElementById('queueHeader');
                q.innerHTML = fileQueue.map((f, i) => `
                    <div class="photo-container">
                        <img src="data:${f.mime};base64,${f.data}" class="photo-bubble">
                        <button onclick="UI.removePhoto(${i})" class="del-btn">√ó</button>
                    </div>
                `).join('');
                const hasItems = fileQueue.length > 0;
                document.getElementById('processBtn').classList.toggle('hidden', !hasItems);
                head.classList.toggle('hidden', !hasItems);
            },

            updateHistory: (newEntry = null) => {
                if(newEntry) {
                    history.unshift(newEntry);
                    if(history.length > 20) history.pop();
                }
                const twoWeeksAgo = Date.now() - (14 * 24 * 60 * 60 * 1000);
                history = history.filter(h => h.timestamp > twoWeeksAgo);
                localStorage.setItem('snap_history', JSON.stringify(history));

                document.getElementById('historyList').innerHTML = history.length === 0 ? 
                    '<p class="text-[10px] text-slate-300 font-bold px-1 italic">No recent scans</p>' :
                    history.map((h, i) => `
                    <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center">
                        <div class="truncate mr-4">
                            <p class="text-[11px] font-black text-indigo-600 truncate">${h.filename}</p>
                            <p class="text-[8px] text-slate-400 font-bold uppercase">${new Date(h.timestamp).toLocaleDateString()}</p>
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <button onclick="downloadFromHistory(${i})" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-xl text-xs">üíæ</button>
                            <button onclick="deleteHistory(${i})" class="w-10 h-10 flex items-center justify-center bg-red-50 rounded-xl text-xs">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            }
        };

        async function processBatch() {
            const apiKey = localStorage.getItem('snap_edi_key');
            if(!apiKey) return alert("API Key Required.");
            document.getElementById('loader').classList.remove('hidden');
            
            try {
                const parts = [
                    { text: `Extract JSON using "Financial Lane Locking":
                        1. ANCHOR: Identify GROSS COST and DISCOUNT/ALLOWANCE columns.
                        2. MATH: net_case_price = (Gross - Discount). This is critical.
                        3. SRP: Suggested Retail is separate; do not confuse with cost.
                        4. SKU: Look for "ITEM#", "PROD", or "SKU".
                        5. DATA: Return vendor_name, invoice_date (MMM-DD-YY), and items: [{upc, description, sku, net_case_price, units_case, qty_ordered, suggested_retail}].` },
                    ...fileQueue.map(f => ({ inlineData: { mimeType: f.mime, data: f.data } }))
                ];
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { 
                    method: 'POST', headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ contents: [{ parts }], generationConfig: { responseMimeType: "application/json" } }) 
                });
                const data = await res.json();
                const parsed = JSON.parse(data.candidates[0].content.parts[0].text);
                
                Engine.vendorName = parsed.vendor_name || "VENDOR";
                Engine.invoiceDate = parsed.invoice_date || "FEB-01-26";
                Engine.items = parsed.items;

                const total = Engine.items.reduce((sum, item) => sum + (Number(item.net_case_price || 0) * Number(item.qty_ordered || 0)), 0);
                document.getElementById('grandTotal').innerText = `$${total.toFixed(2)}`;
                document.getElementById('summaryCard').classList.remove('hidden');
                document.getElementById('actionButtons').classList.remove('hidden');
                
                const ediContent = Engine.items.map(i => Engine.generateEDILine(i)).join('\n');
                UI.updateHistory({ filename: Engine.getFileName(), content: ediContent, timestamp: Date.now() });

            } catch (e) { alert("Processing Error."); }
            finally { document.getElementById('loader').classList.add('hidden'); }
        }

        function downloadEDI() {
            const content = Engine.items.map(i => Engine.generateEDILine(i)).join('\n');
            saveFile(Engine.getFileName(), content);
        }

        function downloadFromHistory(index) {
            const entry = history[index];
            saveFile(entry.filename, entry.content);
        }

        function deleteHistory(index) {
            history.splice(index, 1);
            UI.updateHistory();
        }

        async function saveFile(name, text) {
            const file = new File([text], name, { type: 'text/plain' });
            if (navigator.share && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file] });
            } else {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([text]));
                a.download = name; a.click();
            }
        }

        async function addToQueue(input) {
            for (const file of input.files) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    fileQueue.push({ mime: file.type, data: reader.result.split(',')[1] });
                    UI.renderQueue();
                };
            }
        }

        document.getElementById('apiKeyInput').value = localStorage.getItem('snap_edi_key') || "";
        UI.updateHistory();
    </script>
</body>
</html>
