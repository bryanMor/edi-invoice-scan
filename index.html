<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnapEDI Pro v2.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .edi-line { border-left: 4px solid #10b981; background: #0f172a; color: #38bdf8; }
    </style>
</head>
<body class="pb-10">

    <nav class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-black text-indigo-600 tracking-tighter uppercase italic">SnapEDI Pro</h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">v2.4 Brand Intelligence</p>
        </div>
        <button onclick="toggleSettings()" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center text-slate-600 active:scale-90 transition-transform">
            <i class="fa-solid fa-sliders"></i>
        </button>
    </nav>

    <main class="max-w-xl mx-auto p-6 space-y-6">
        <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
            <div class="relative z-10">
                <h2 class="text-2xl font-black mb-2">Scan & Verify</h2>
                <p class="text-slate-400 text-xs font-medium mb-6">AI-Powered GS1 Prefix Detection</p>
                <label class="inline-flex items-center gap-3 bg-indigo-600 text-white px-8 py-5 rounded-2xl font-black text-sm cursor-pointer shadow-lg active:scale-95 transition-all">
                    <i class="fa-solid fa-camera-retro text-lg"></i> CAPTURE INVOICE
                    <input type="file" accept="image/*" multiple capture="environment" class="hidden" onchange="handleFiles(this)">
                </label>
            </div>
            <i class="fa-solid fa-microchip absolute -right-6 -bottom-6 text-9xl text-white/5 rotate-12"></i>
        </div>

        <div id="loader" class="hidden text-center py-8">
            <div class="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Auditing Brands & Locking Grid...</p>
        </div>

        <div id="resultsCard" class="hidden space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="flex justify-between items-end px-2">
                <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">EDI B-Record Stream</h3>
                <span id="grandTotal" class="text-2xl font-black text-emerald-600">$0.00</span>
            </div>
            <div id="ediPreview" class="edi-line p-5 rounded-3xl mono text-[9px] leading-relaxed overflow-x-auto whitespace-pre shadow-2xl"></div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="downloadLatest()" class="bg-indigo-600 text-white py-4 rounded-2xl font-black text-xs shadow-lg active:scale-95 transition-all">DOWNLOAD .TXT</button>
                <button onclick="location.reload()" class="bg-slate-200 text-slate-700 py-4 rounded-2xl font-black text-xs active:scale-95 transition-all">CLEAR</button>
            </div>
        </div>

        <div class="space-y-4">
            <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest px-2">Audit History</h3>
            <div id="historyList" class="space-y-3"></div>
        </div>
    </main>

    <div id="settings" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="toggleSettings()"></div>
        <div class="absolute right-0 top-0 bottom-0 w-80 bg-white p-8 shadow-2xl">
            <h2 class="text-xl font-black mb-6 italic">Configuration</h2>
            <div class="space-y-6">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">Gemini API Key</label>
                    <input id="apiKey" type="password" class="w-full bg-slate-100 border-none p-4 rounded-xl text-sm font-bold focus:ring-2 ring-indigo-500 outline-none" placeholder="Enter Key...">
                </div>
                <button onclick="saveSettings()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black text-sm tracking-widest shadow-xl">ACTIVATE ENGINE</button>
            </div>
        </div>
    </div>

    <script>
        let history = JSON.parse(localStorage.getItem('snap_history_v24') || '[]');
        let lastEDI = "";
        let lastFileName = "";

        const EDI_RULES = {
            build: function(item) {
                const num = (v) => String(v || "").replace(/\D/g, "");
                const money = (v) => Math.round((Number(v) || 0) * 100).toString().replace(/\D/g, "");

                // Rule: UPC (Pos 2-12). Take 11 digits as provided by AI (which verified prefix via Item Name).
                let upc = num(item.upc).padEnd(11, '0').slice(0, 11);

                // Rule: Description (Pos 13-38). Strict 26 characters.
                let desc = String(item.description || "ITEM").toUpperCase().padEnd(26, ' ').substring(0, 26);

                // Rule: SKU (Pos 39-44). 6 digits.
                let sku = num(item.sku).padStart(6, '0').slice(-6);

                // Rule: Net Case Cost (Pos 45-49). 5 digits cents.
                let cost = money(item.net_case_price).padStart(5, '0').slice(-5);

                // Rule: Retail (Pos 63-67). 5 digits cents. (Single Unit Retail).
                let retail = money(item.suggested_retail || 0).padStart(5, '0').slice(-5);
                
                let units = num(item.units_case || 1).padStart(6, '0').slice(-6);
                let qty = num(item.qty_ordered).padStart(4, '0').slice(-4);

                return `B${upc}${desc}${sku}${cost}CS${units}+${qty}${retail}001`;
            }
        };

        async function processInvoice(files) {
            const key = document.getElementById('apiKey').value;
            if(!key) return alert("API Key Missing");
            document.getElementById('loader').classList.remove('hidden');
            
            try {
                const base64Imgs = await Promise.all(Array.from(files).map(f => fileToBase64(f)));
                const masterPrompt = {
                    text: `Analyze this invoice and extract JSON using "Brand-Aware Grid-Lock":
                    1. AUDIT: For EACH row, identify the Item Name (e.g., 'Best Ice', 'Corona').
                    2. UPC REPAIR: If the UPC column has 10 digits, determine the correct leading digit (0-9) based on that specific brand's GS1 registration. Return the full 11-digit string.
                    3. GRID-LOCK: Identify vertical columns for ITEM#, U.P.C., DESCRIPTION, NET, and SSP (Retail). Once identified for the first two items, lock coordinates.
                    4. RETAIL: Use the 'SSP' column for the unit retail value.
                    5. JSON: {vendor_name, invoice_date(MMM-DD-YY), items: [{upc, description, sku, net_case_price, units_case, qty_ordered, suggested_retail}]}`
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [masterPrompt, ...base64Imgs.map(b => ({ inlineData: { mimeType: "image/jpeg", data: b.split(',')[1] } }))] }],
                        generationConfig: { responseMimeType: "application/json", temperature: 0.1 }
                    })
                });

                const raw = await response.json();
                const data = JSON.parse(raw.candidates[0].content.parts[0].text);
                
                lastEDI = data.items.map(i => EDI_RULES.build(i)).join('\n');
                lastFileName = `${data.vendor_name.toUpperCase().replace(/\s/g,'').slice(0,12)}_${data.invoice_date}.txt`;

                const total = data.items.reduce((s, i) => s + (i.net_case_price * i.qty_ordered), 0);
                document.getElementById('grandTotal').innerText = `$${total.toFixed(2)}`;
                document.getElementById('ediPreview').innerText = lastEDI;
                document.getElementById('resultsCard').classList.remove('hidden');

                history.unshift({ id: Date.now(), name: lastFileName, content: lastEDI, date: new Date().toLocaleDateString() });
                localStorage.setItem('snap_history_v24', JSON.stringify(history.slice(0, 20)));
                renderHistory();
            } catch (e) { alert("Engine Error. Check API Key or Connection."); console.error(e); }
            finally { document.getElementById('loader').classList.add('hidden'); }
        }

        // UI Helpers
        function fileToBase64(file) { return new Promise(r => { const rd = new FileReader(); rd.readAsDataURL(file); rd.onload = () => r(rd.result); }); }
        function handleFiles(input) { if(input.files.length) processInvoice(input.files); }
        function toggleSettings() { document.getElementById('settings').classList.toggle('hidden'); }
        function saveSettings() { localStorage.setItem('snap_key', document.getElementById('apiKey').value); toggleSettings(); }
        function downloadLatest() { saveAs(lastFileName, lastEDI); }
        function saveAs(n, t) {
            const b = new Blob([t], {type:'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = n; a.click();
        }
        function renderHistory() {
            document.getElementById('historyList').innerHTML = history.map(h => `
                <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 flex justify-between items-center">
                    <div class="truncate">
                        <p class="text-[10px] font-black text-indigo-600 uppercase tracking-tighter">${h.name}</p>
                        <p class="text-[8px] text-slate-400 font-bold">${h.date}</p>
                    </div>
                    <button onclick="saveAs('${h.name}', '${h.content.replace(/\n/g, '\\n')}')" class="w-12 h-12 bg-slate-900 text-white rounded-2xl active:scale-90 transition-transform"><i class="fa-solid fa-cloud-arrow-down"></i></button>
                </div>
            `).join('');
        }
        window.onload = () => { document.getElementById('apiKey').value = localStorage.getItem('snap_key') || ""; renderHistory(); };
    </script>
</body>
</html>
