<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapEDI Pro - v2.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .scroll-hide::-webkit-scrollbar { display: none; }
        .settings-panel { transition: transform 0.3s ease-in-out; }
        .photo-container { position: relative; flex: 0 0 85px; }
        .photo-bubble { 
            width: 85px; height: 125px; object-fit: cover; 
            border-radius: 10px; border: 2px solid #e2e8f0; 
            background: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .del-btn { 
            position: absolute; top: -8px; right: -8px; 
            background: #ef4444; color: white; border-radius: 50%; 
            width: 24px; height: 24px; display: flex; 
            align-items: center; justify-content: center; 
            font-size: 14px; font-weight: bold; border: 2px solid white;
        }
    </style>
</head>
<body class="bg-[#F8FAFC] font-sans text-slate-900 min-h-screen pb-20">

    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-100 px-6 py-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-black tracking-tighter text-indigo-600">SnapEDI <span class="text-slate-400 font-bold text-xs uppercase tracking-widest ml-1">v2.4</span></h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Professional EDI Portal</p>
        </div>
        <button onclick="UI.toggleSettings()" class="w-10 h-10 bg-slate-50 rounded-2xl flex items-center justify-center text-lg border border-slate-100">‚öôÔ∏è</button>
    </header>

    <main class="max-w-md mx-auto px-6 pt-6 space-y-6">
        <div class="bg-indigo-600 rounded-[2.5rem] p-8 text-white shadow-2xl shadow-indigo-200 relative overflow-hidden">
            <div class="relative z-10">
                <h2 class="text-2xl font-black leading-tight mb-2">Scan Invoice</h2>
                <p class="text-indigo-100 text-xs font-medium mb-6 opacity-80">Batch process images into EDI B-Records</p>
                <label class="inline-flex items-center gap-3 bg-white text-indigo-600 px-6 py-4 rounded-2xl font-black text-sm active:scale-95 transition-transform cursor-pointer shadow-lg">
                    <span class="text-xl">üì∏</span> TAKE PHOTOS
                    <input type="file" accept="image/*" multiple capture="environment" class="hidden" onchange="addToQueue(this)">
                </label>
            </div>
            <div class="absolute -right-10 -bottom-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
        </div>

        <div id="queueHeader" class="hidden flex justify-between items-center px-1">
            <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Batch Queue</h3>
            <button onclick="UI.clearQueue()" class="text-[10px] font-bold text-red-500 uppercase">Clear All</button>
        </div>
        <div id="photoQueue" class="flex gap-4 overflow-x-auto pb-2 scroll-hide"></div>

        <button id="processBtn" onclick="processBatch()" class="hidden w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black text-sm shadow-xl flex items-center justify-center gap-3 active:scale-[0.98] transition-all">
            PROCESS BATCH <span class="bg-white/20 px-2 py-0.5 rounded-lg text-[10px]">GEMINI AI</span>
        </button>

        <div id="summaryCard" class="hidden bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Invoice Total</p>
                    <h3 id="grandTotal" class="text-3xl font-black text-slate-900">$0.00</h3>
                </div>
                <div class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full text-[10px] font-black uppercase">Verified</div>
            </div>
            <div id="actionButtons" class="hidden grid grid-cols-2 gap-3">
                <button onclick="downloadEDI()" class="bg-indigo-50 text-indigo-600 py-4 rounded-2xl font-black text-xs border border-indigo-100">üíæ DOWNLOAD TXT</button>
                <button onclick="window.location.reload()" class="bg-slate-50 text-slate-600 py-4 rounded-2xl font-black text-xs">üîÑ NEW SCAN</button>
            </div>
        </div>

        <div class="space-y-4">
            <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest px-1">Recent Activity</h3>
            <div id="historyList" class="space-y-3"></div>
        </div>
    </main>

    <div id="settingsOverlay" class="fixed inset-0 z-50 translate-x-full settings-panel">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="UI.toggleSettings()"></div>
        <div class="absolute right-0 top-0 bottom-0 w-80 bg-white p-8 shadow-2xl">
            <h2 class="text-xl font-black mb-6">Settings</h2>
            <div class="space-y-6">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Gemini API Key</label>
                    <input id="apiKeyInput" type="password" class="w-full bg-slate-50 border border-slate-100 p-4 rounded-xl text-sm font-bold focus:ring-2 ring-indigo-500 outline-none" placeholder="Paste Key Here">
                </div>
                <button onclick="UI.saveSettings()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-black text-sm shadow-lg shadow-indigo-100">SAVE CONFIG</button>
            </div>
        </div>
    </div>

    <div id="loader" class="hidden fixed inset-0 z-[60] bg-white flex flex-center flex-col items-center justify-center p-10 text-center">
        <div class="w-16 h-16 border-4 border-slate-100 border-t-indigo-600 rounded-full animate-spin mb-6"></div>
        <h2 class="text-lg font-black text-slate-900 mb-2">Analyzing Invoices</h2>
        <p class="text-xs font-medium text-slate-400 leading-relaxed">Gemini is applying Grid-Lock and identifying UPC sequences...</p>
    </div>

    <script>
        let fileQueue = [];
        let history = JSON.parse(localStorage.getItem('snap_history') || '[]');

        const Engine = {
            vendorName: "VENDOR",
            invoiceDate: "FEB-03-26",
            items: [],
            margin: 1.35,

            getFileName: function() {
                const words = this.vendorName.toUpperCase().split(' ').filter(w => w.length > 1).slice(0, 2).join('');
                return `${words.substring(0, 14)}_${this.invoiceDate}.txt`;
            },

            generateEDILine: function(item) {
                const onlyNums = (val) => String(val || "0").replace(/\D/g, "");
                const toCents = (val) => Math.round((Number(val) || 0) * 100).toString().replace(/\D/g, "");

                // RULE: UPC (11 digits). If 12 provided, take first 11. If 10 provided, Gemini verified the 11th.
                let upc = onlyNums(item.upc).padStart(11, '0').slice(0, 11);
                
                // RULE: Exact first 26 characters of the description.
                let desc = String(item.description || "ITEM").toUpperCase()
                           .padEnd(26, ' ')
                           .substring(0, 26);

                let sku = onlyNums(item.sku).padStart(6, '0').slice(-6);
                let qty = onlyNums(item.qty_ordered).padStart(4, '0').slice(-4);
                let units = onlyNums(item.units_case || 1).padStart(6, '0').slice(-6);
                let cost = toCents(item.net_case_price).padStart(5, '0').slice(-5);
                
                const srpVal = Number(item.suggested_retail) || 0;
                const retailCalc = srpVal > 0 ? srpVal : ((Number(item.net_case_price) || 0) / (Number(item.units_case) || 1)) * this.margin;
                let retail = toCents(retailCalc).padStart(5, '0').slice(-5);

                // FORMAT: B(1) + UPC(11) + DESC(26) + SKU(6) + COST(5) + CS(2) + UNITS(6) + DELIM(1) + QTY(4) + RETAIL(5) + CONST(3)
                return `B${upc}${desc}${sku}${cost}CS${units}+${qty}${retail}001`;
            }
        };

        const UI = {
            toggleSettings: () => document.getElementById('settingsOverlay').classList.toggle('translate-x-full'),
            saveSettings: () => { localStorage.setItem('snap_edi_key', document.getElementById('apiKeyInput').value); UI.toggleSettings(); },
            clearQueue: () => { fileQueue = []; UI.renderQueue(); },
            removePhoto: (index) => { fileQueue.splice(index, 1); UI.renderQueue(); },

            renderQueue: () => {
                const q = document.getElementById('photoQueue');
                const head = document.getElementById('queueHeader');
                q.innerHTML = fileQueue.map((f, i) => `
                    <div class="photo-container">
                        <img src="data:${f.mime};base64,${f.data}" class="photo-bubble">
                        <button onclick="UI.removePhoto(${i})" class="del-btn">√ó</button>
                    </div>
                `).join('');
                const hasItems = fileQueue.length > 0;
                document.getElementById('processBtn').classList.toggle('hidden', !hasItems);
                head.classList.toggle('hidden', !hasItems);
            },

            updateHistory: (newEntry = null) => {
                if(newEntry) {
                    history.unshift(newEntry);
                    if(history.length > 20) history.pop();
                }
                localStorage.setItem('snap_history', JSON.stringify(history));
                document.getElementById('historyList').innerHTML = history.length === 0 ? 
                    '<p class="text-[10px] text-slate-300 font-bold px-1 italic">No recent scans</p>' :
                    history.map((h, i) => `
                    <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center">
                        <div class="truncate mr-4">
                            <p class="text-[11px] font-black text-indigo-600 truncate">${h.filename}</p>
                            <p class="text-[8px] text-slate-400 font-bold uppercase">${new Date(h.timestamp).toLocaleDateString()}</p>
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <button onclick="downloadFromHistory(${i})" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-xl text-xs">üíæ</button>
                            <button onclick="deleteHistory(${i})" class="w-10 h-10 flex items-center justify-center bg-red-50 rounded-xl text-xs">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            }
        };

        async function processBatch() {
            const apiKey = localStorage.getItem('snap_edi_key');
            if(!apiKey) return alert("API Key Required.");
            document.getElementById('loader').classList.remove('hidden');
            
            try {
                const parts = [
                    { text: `Extract JSON using "Grid-Lock Extraction":
                        1. HANDSHAKE: Use first two items to identify vertical columns for UPC, SKU, Description, and Net Price.
                        2. GRID-LOCK: Once identified, extract all rows using these locked coordinates.
                        3. UPC RULE: Extract the full code. If 12 digits, return first 11. If 10 digits, search/verify the 11th digit using the product description.
                        4. DESC RULE: Extract exact description text from invoice.
                        5. DATA: Return JSON: {vendor_name, invoice_date (MMM-DD-YY), items: [{upc, description, sku, net_case_price, units_case, qty_ordered, suggested_retail}]}.` },
                    ...fileQueue.map(f => ({ inlineData: { mimeType: f.mime, data: f.data } }))
                ];
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { 
                    method: 'POST', headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ contents: [{ parts }], generationConfig: { responseMimeType: "application/json" } }) 
                });
                const data = await res.json();
                const parsed = JSON.parse(data.candidates[0].content.parts[0].text);
                
                Engine.vendorName = parsed.vendor_name || "VENDOR";
                Engine.invoiceDate = parsed.invoice_date || "FEB-03-26";
                Engine.items = parsed.items;

                const total = Engine.items.reduce((sum, item) => sum + (Number(item.net_case_price || 0) * Number(item.qty_ordered || 0)), 0);
                document.getElementById('grandTotal').innerText = `$${total.toFixed(2)}`;
                document.getElementById('summaryCard').classList.remove('hidden');
                document.getElementById('actionButtons').classList.remove('hidden');
                
                const ediContent = Engine.items.map(i => Engine.generateEDILine(i)).join('\n');
                UI.updateHistory({ filename: Engine.getFileName(), content: ediContent, timestamp: Date.now() });

            } catch (e) { alert("Processing Error."); }
            finally { document.getElementById('loader').classList.add('hidden'); }
        }

        function downloadEDI() {
            const content = Engine.items.map(i => Engine.generateEDILine(i)).join('\n');
            saveFile(Engine.getFileName(), content);
        }

        function downloadFromHistory(index) {
            const entry = history[index];
            saveFile(entry.filename, entry.content);
        }

        function deleteHistory(index) {
            history.splice(index, 1);
            UI.updateHistory();
        }

        async function saveFile(name, text) {
            const file = new File([text], name, { type: 'text/plain' });
            if (navigator.share && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file] });
            } else {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([text]));
                a.download = name; a.click();
            }
        }

        async function addToQueue(input) {
            for (const file of input.files) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    fileQueue.push({ mime: file.type, data: reader.result.split(',')[1] });
                    UI.renderQueue();
                };
            }
        }

        document.getElementById('apiKeyInput').value = localStorage.getItem('snap_edi_key') || "";
        UI.updateHistory();
    </script>
</body>
</html>
