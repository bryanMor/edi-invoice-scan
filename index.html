<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INVOICE TO EDI v2.0</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono&display=swap');
body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
.mono { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }
.edi-preview {
    background: #0f172a;
    color: #38bdf8;
    padding: 12px;
    border-radius: 6px;
    font-size: 0.7rem;
    white-space: pre;
    overflow-x: auto;
    border-left: 4px solid #10b981;
}
</style>
</head>

<body class="pb-20 text-slate-900">

<header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
    <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-xl font-bold tracking-tight uppercase">
            INVOICE TO <span class="text-emerald-400">EDI</span>
        </h1>
    </div>
</header>

<main class="max-w-4xl mx-auto p-4 space-y-6">

    <div class="bg-slate-900 rounded-3xl p-8 shadow-2xl text-center">
        <p class="text-slate-400 text-xs font-bold uppercase tracking-[0.2em] mb-2">
    		Last Invoice Total
	</p>

        <h2 id="grandTotal" class="text-5xl font-extrabold text-emerald-400">$0.00</h2>
    </div>

    <section class="bg-white border-2 border-dashed border-slate-300 rounded-3xl p-10 text-center cursor-pointer hover:border-emerald-400 transition"
        onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" multiple accept="image/*" class="hidden"
            onchange="handleFiles(this.files)">
        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-camera text-2xl text-slate-400"></i>
        </div>
        <p class="text-slate-700 font-bold text-lg">Snap or Upload Invoices</p>
    </section>

    <div id="queueSection" class="hidden">
        <div id="batchQueue" class="space-y-2 mb-4"></div>
        <button id="processBtn" onclick="processBatch()"
            class="w-full bg-emerald-600 text-white font-black py-5 rounded-2xl hover:bg-emerald-700 transition uppercase tracking-[0.15em] text-lg">
            Convert to EDI
        </button>
    </div>

    <section>
        <div class="flex justify-between items-end mb-4">
            <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">History</h3>
            
	    
        </div>
        <div id="historyList" class="space-y-4"></div>
    </section>

</main>



<script>

window.batchFiles = [];
let history = JSON.parse(localStorage.getItem('invoice_edi_v2') || '[]');

function parseQtySafe(v) {
  if (v === null || v === undefined) return 0;

  const s = String(v)
    .replace(/[Oo]/g, "0")
    .replace(/[lI]/g, "1")
    .replace(/[^0-9]/g, "")
    .trim();

  if (s === "") return 0;

  const n = parseInt(s, 10);
  return Number.isNaN(n) ? 0 : n;
}


function handleFiles(files) {
    window.batchFiles = Array.from(files);
    const queue = document.getElementById('batchQueue');
    const section = document.getElementById('queueSection');

    queue.innerHTML = window.batchFiles.map(f =>
        `<div class="bg-white p-3 border rounded-lg text-sm shadow-sm flex justify-between">
            <span>${f.name}</span>
            <i class="fas fa-check-circle text-emerald-500"></i>
        </div>`
    ).join('');

    section.classList.remove('hidden');
}

async function processBatch() {

    const btn = document.getElementById('processBtn');
    btn.disabled = true;
    btn.innerText = "Processing...";

    try {

        for (const file of window.batchFiles) {

            const base64Data = await fileToBase64(file);

            const response = await fetch('https://invoice-backend-esbh.onrender.com/api/extract', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ base64Image: base64Data })
            });

            if (!response.ok) {
                throw new Error("Server error: " + response.status);
            }

            const result = await response.json();

            if (!result.items) {
                throw new Error("Invalid response format");
            }

            processAndStore(result, file.name);
        }

        document.getElementById('queueSection').classList.add('hidden');

    } catch (err) {
        alert("Error: " + err.message);
    }

    btn.disabled = false;
    btn.innerText = "Convert to EDI";
}

function generateBRecord(item) {
    let r = "B";

    // 1. UPC: 11 digits, strictly numeric, space padded to maintain length
    r += String(item.upc || "").replace(/\D/g, '').substring(0, 11).padEnd(11, ' ');

    // 2. Description: 26 chars, uppercase, literal passthrough
    r += String(item.description || "").toUpperCase().substring(0, 26).padEnd(26, ' ');

    // 3. SKU: Last 5 digits, zero padded
    let rawSku = String(item.sku || "").replace(/\D/g, '');
    r += rawSku.slice(-5).padStart(5, '0');

    // 4. Net Cost: 6 digits (cents), zero padded
    r += Math.round(parseFloat(item.netCost || 0) * 100).toString().padStart(6, '0').substring(0, 6);

    // 5. UOM: Always 2 characters (CS)
    r += "CS";

    // 6. UnitsPerCase: 6 digits, zero padded (No calculation, direct from item)
    let u = parseInt(item.unitsPerCase, 10);
    if (isNaN(u) || u <= 0) u = 1; 
    r += u.toString().padStart(6, '0').substring(0, 6);

    // 7. Quantity Ordered: THE FIX - No default to 1, allows 0 and 2
    r += "+";
const qty = parseQtySafe(item.qtyOrdered);

// ✅ do not output 0-qty lines at all
if (qty === 0) return null;

r += String(qty).padStart(4, '0').substring(0, 4);

    // 8. SRP/SSP: FIXED ZEROS (per your 6-point logic)
    r += "00000";

    // 9. Constant
    r += "001";

    // Final Length Check: Ensure exactly 70 characters
    return r.padEnd(70).substring(0, 70);
}

function processAndStore(data) {

    let total = 0;

    const edi = data.items
  .map(i => {
    const qty = parseQtySafe(i.qtyOrdered);

    // ✅ skip 0 qty lines entirely (no total, no record)
    if (qty === 0) return null;

    total += (parseFloat(i.netCost || 0) * qty);
    return generateBRecord(i);
  })
  .filter(Boolean)
  .join('\n');


    const vendor = (data.vendorName || "VENDOR")
        .replace(/[^a-zA-Z0-9]/g, '')
        .substring(0, 14)
        .toUpperCase();

    const date = data.invoiceDate || new Date().toISOString().slice(0, 10);

    const fileName = `${vendor}_${date}.txt`;

    history.unshift({
        id: Date.now(),
        fileName,
        total: total.toFixed(2),
        edi
    });

    history = history.slice(0, 50);

    localStorage.setItem('invoice_edi_v2', JSON.stringify(history));

    document.getElementById('grandTotal').innerText = `$${total.toFixed(2)}`;

    renderHistory();
}

function renderHistory() {
    const list = document.getElementById('historyList');

    list.innerHTML = history.map(item => `
        <div class="bg-white p-5 rounded-2xl border shadow-sm">

            <div class="flex justify-between mb-3">
                <span class="font-bold">${item.fileName}</span>
                <span class="text-emerald-600 font-black">$${item.total}</span>
            </div>

            <div class="edi-preview mono mb-4">${item.edi}</div>

            <div class="flex gap-2">
                <button onclick="downloadTxt('${item.id}')"
                    class="w-full bg-slate-900 text-white py-3 rounded-xl text-xs font-bold uppercase">
                    Download
                </button>

                <button onclick="deleteInvoice('${item.id}')"
                    class="w-full bg-red-600 text-white py-3 rounded-xl text-xs font-bold uppercase">
                    Delete
                </button>
            </div>

        </div>
    `).join('');
}


async function downloadTxt(id) {
    const item = history.find(h => String(h.id) === String(id));
    if (!item) return alert("File not found in history.");

    const blob = new Blob([item.edi], { type: 'text/plain' });
    const file = new File([blob], item.fileName, { type: 'text/plain' });

    // Mobile share (files)
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
            await navigator.share({
                title: item.fileName,
                text: "Invoice EDI File",
                files: [file]
            });
            return;
        } catch (err) {
            console.log("Share cancelled or failed", err);
        }
    }

    // Desktop fallback
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = item.fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}





function fileToBase64(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
    });
}

function deleteInvoice(id) {
    if (!confirm("Delete this invoice?")) return;

    const index = history.findIndex(item => String(item.id) === String(id));
    if (index === -1) return;

    history.splice(index, 1);
    localStorage.setItem('invoice_edi_v2', JSON.stringify(history));

    renderHistory();
}


window.onload = () => {
    renderHistory();
};

</script>
</body>
</html>
